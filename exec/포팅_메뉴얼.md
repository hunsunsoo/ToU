# ì„œë¹„ìŠ¤ ë°°í¬ ë©”ë‰´ì–¼

<details>
<summary>ê¸°ìˆ  ìŠ¤íƒ</summary>
<div markdown="1">      

#### ğŸ“Œ ë¸”ë¡ì²´ì¸
- `java`
- `Hyperledger Fabric`

#### ğŸ“Œ í”„ë¡ íŠ¸ ì—”ë“œ
- `VisualCode : ìµœì‹ íŒ (1.82.2)`
- `React - 18.2.0`
- `axios - 1.5.0`
- `NodeJS - 18.16.1`
- `npm - 9.6.7`
- `recoil - 0.7.7`
- `styled-components - 6.0.7`
- `pwa`

#### ğŸ“Œ ë°±ì—”ë“œ
- `jdk - 17.0.9`
- `gradle - 8.3.0`
- `springboot - 3.0.12`
- `mysql - 8.1.0`

#### ğŸ“Œ ì¸í”„ë¼
- `docker - 24.0.5`
- `docker-compose - 2.1.0`
- `apt - 2.0.9`
- `nginx - 1.18.0`
- `jenkins lts`
- `AWS EC2`


</div>
</details>

<details>
<summary>ì¸í”„ë¼</summary>
<div markdown="1">      

- ì„œë²„ ì ‘ì†(cmd)
    1. ì§€ê¸‰ë°›ì€ pemí‚¤ë¥¼ `C:\Users\SSAFY` ê²½ë¡œì— ë‹¤ìš´
    2. cmd ì¼œê³  **`ssh -i K9B310T.pemÂ [ubuntu@k9b310.p.ssafy.io](mailto:ubuntu@k9b310.p.ssafy.io)`** ì…ë ¥
- ë°©í™”ë²½ ì„¤ì •
    
    ê¸°ë³¸ì ìœ¼ë¡œ 22ë²ˆ í¬íŠ¸ëŠ” ì—´ë ¤ìˆë‹¤ (ì›ê²©ì ‘ì†ìš©)

    

# 1. EC2 Setting

## 1.1 EC2 ì ‘ì†í•˜ê¸°

- MobaXterní™œìš©
- SSH ì„ íƒ
- Romete host : j9b206.p.ssafy.io
- User privatee Key : ë°œê¸‰ë°›ì€ keyì…ë ¥


## 1.2 ìš°ë¶„íˆ¬ ë°©í™”ë²½(UFW) ì„¤ì •

```bash
sudo ufw default deny incoming # ëª¨ë“  ì¸ë°”ìš´ë“œ ì—°ê²° ì°¨ë‹¨
sudo ufw default allow outgoing # ëª¨ë“  ì•„ì›ƒë°”ìš´ë“œ ì—°ê²° í—ˆìš©
sudo ufw allow ssh # 22ë²ˆ í¬íŠ¸ í—ˆìš©
sudo ufw allow http # 80ë²ˆ í¬íŠ¸ í—ˆìš©
sudo ufw allow https # 443 í¬íŠ¸ í—ˆìš©
```

- ë°©í™”ë²½ ì‹¤í–‰ `sudo ufw enable`
    
- í—ˆìš©ëœ í¬íŠ¸ í™•ì¸ `sudo ufw status`

<aside>
ğŸ’¡ 3000ë²ˆ, 8080ë²ˆ í¬íŠ¸ëŠ” ì•ˆì—´ì–´ë„ ë˜ë‚˜ìš”?
â‡’ ì•ˆì—´ì–´ë„ ì  í‚¨ìŠ¤ì—ì„œ ê´€ë¦¬í•˜ê³  ìˆìŒ

</aside>

## 1.3 Docker ì„¤ì¹˜

- ê³µì‹ ë¬¸ì„œë¥¼ ë¨¼ì € í™•ì¸

[Install Docker Engine on Ubuntu](https://docs.docker.com/engine/install/ubuntu/)

- ec2ì— docker ì„¤ì¹˜
    
    ```bash
    sudo apt-get update
    sudo apt-get install ca-certificates curl gnupg
    
    sudo install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    sudo chmod a+r /etc/apt/keyrings/docker.gpg
    
    echo \
      "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
      "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | \
      sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    ```
    
- docker engineê³¼ ê·¸ì— ë”°ë¥¸ pluginì„¤ì¹˜
    
    ```bash
    sudo apt-get update
    sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    
    sudo apt install docker-compose
    
    # ì •ìƒ ì„¤ì¹˜ ë˜ì—‡ëŠ”ì§€ í™•ì¸
    sudo docker -v
    sudo docker compose version
    ```
    

## 1.4 Nginx ì„¤ì •

### Nginx ì„¤ì¹˜

```bash
sudo apt-get update
sudo apt-get upgrade
sudo apt-get install nginx
```

### SSL ì„¤ì • (feat. Certbot)

```bash
# snapì„ ì´ìš©í•˜ì—¬ core ì„¤ì¹˜ -> snapì„ ìµœì‹  ë²„ì „ìœ¼ë¡œ ìœ ì§€í•˜ê¸° ìœ„í•´ ì„¤ì¹˜
sudo snap install core
# coreë¥¼ refresh í•´ì¤€ë‹¤.
sudo snap refresh core
# ê¸°ì¡´ì— ì˜ëª»ëœ certbotì´ ì„¤ì¹˜ë˜ì–´ìˆì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ì‚­ì œ í•´ì¤€ë‹¤.
sudo apt remove certbot
# certbot ì„¤ì¹˜
sudo snap install --classic certbot
# certbot ëª…ë ¹ì„ ë¡œì»¬ì—ì„œ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ snapì˜ certbot íŒŒì¼ì„ ë¡œì»¬ì˜ cerbotê³¼ ë§í¬(ì—°ê²°) ì‹œì¼œì¤€ë‹¤. -s ì˜µì…˜ì€ ì‹¬ë³¼ë¦­ë§í¬ë¥¼ í•˜ê² ë‹¤ëŠ” ê²ƒ.
sudo ln -s /snap/bin/certbot /usr/bin/certbot
# certbot ì‚¬ìš©í•´ ssl ì„¤ì •
sudo certbot --nginx
```

### Nginx ì„¤ì • íŒŒì¼ (feat. ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ)

> `sudo vim /etc/nginx/conf.d/default.conf`
> 

**Certbot ì‚¬ìš©**

```bash
server {
    #  80ë²ˆ í¬íŠ¸ì—ì„œ ì—°ê²° ìˆ˜ì‹ 
    listen 80;
    server_name k9b310.p.ssafy.io;
    return 301 https://$host$request_uri;
}

# HTTPS ë¡œ ì—°ê²° ìˆ˜ì‹ 
server {
    listen 443 ssl;
    server_name k9b310.p.ssafy.io;

    ssl_certificate /etc/letsencrypt/live/k9b310.p.ssafy.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/k9b310.p.ssafy.io/privkey.pem;

    # springbootì— ëŒ€í•œ í”„ë¡ì‹œ ì„¤ì •
    location /api {
        # rewrite ^/api(/.*)$ $1 break;
        proxy_pass http://k9b310.p.ssafy.io:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # í”„ë¡ íŠ¸ì— ëŒ€í•œ í”„ë¡ì‹œ ì„¤ì •
    location / {
        proxy_pass http://k9b310.p.ssafy.io:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

**ZeroSSL ì‚¬ìš©**

- ìˆ¨ê¹€
    
    ```bash
    server {
        #  80ë²ˆ í¬íŠ¸ì—ì„œ ì—°ê²° ìˆ˜ì‹ 
        listen 80;
        server_name k9b310.p.ssafy.io;
        return 301 https://$host$request_uri;
    }
    
    # HTTPS ë¡œ ì—°ê²° ìˆ˜ì‹ 
    server {
        listen 443 ssl;
        server_name k9b310.p.ssafy.io;
    
    		root /var/www/k9b310.p.ssafy.io;
    
        # springbootì— ëŒ€í•œ í”„ë¡ì‹œ ì„¤ì •
        location /api {
            # rewrite ^/api(/.*)$ $1 break;
            proxy_pass http://k9b310.p.ssafy.io:8080;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    
        # í”„ë¡ íŠ¸ì— ëŒ€í•œ í”„ë¡ì‹œ ì„¤ì •
        location / {
            proxy_pass http://k9b310.p.ssafy.io:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    
    		location ~/.well-known/pki-validation {
            default_type "text/plain";
            index F8A1B3624552EBC3AC088EEB55E82E73.txt;
        }
    
    }
    ```
    

### Nginx ì„¤ì • ì ìš©

```bash
sudo nginx -t
sudo service nginx restart
```

## 1.5 MySQL ì„¤ì •

### MySQL ì´ë¯¸ì§€ pull

```bash
sudo docker pull mysql:8.0.22
```

### Docker ì»¨í…Œì´ë„ˆ ë³¼ë¥¨ ì„¤ì • ë° í™•ì¸

```bash
# ë³¼ë¥¨ ì„¤ì •
sudo docker volume create mysql-volume
# ë³¼ë¥¨ í™•ì¸
sudo docker volume ls
```

### MySQL ì»¨í…Œì´ë„ˆ ì‹¤í–‰

```bash
# mysql: 8.0.22 ë²„ì „ ì„¤ì¹˜
sudo docker run -d --name mysql-container -p 2231:3306 -v mysql-volume:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=1234 mysql:8.0.22

~~# ê°€ì¥ ìµœì‹ ë²„ì „ ì„¤ì¹˜~~
~~sudo docker run -d --name mysql-container -p 2231:3306 -v mysql-volume:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=1234 mysql:latest~~
```

### MySQL ìƒˆ ê³„ì • ìƒì„± ë° ê¶Œí•œ ì„¤ì •

> `mysql -u root -p` # MySQL ì„œë²„ ì ‘ì†
> 

```bash
sudo docker exec -it mysql-container bash
mysql -u root -p
# ì¶”í›„ì— ì‚­ì œí• ê±°ë‹ˆ ë¹„ë²ˆ ì…ë ¥ ì•ˆí•´ë„ë¨(or ê°„ë‹¨í•œê±¸ë¡œ í•´ë„ë¨)
```

```bash
# ìƒˆ ê³„ì • ìƒì„±
mysql> CREATE USER tou@'%' identified by 'ssa-fyt-oussaf-yb310-tou';
# ê¶Œí•œ ì„¤ì •
mysql> GRANT ALL PRIVILEGES ON *.* to tou@'%';
mysql> FLUSH PRIVILEGES;
mysql> exit;
```

### ìƒˆ ê³„ì •ìœ¼ë¡œ DB ìƒì„±

```bash
# ìƒì„±í•œ ê³„ì •ìœ¼ë¡œ MySQL ì„œë²„ ì ‘ì†
bash# mysql -u tou -p
# DB ìƒì„± ë° í™•ì¸
mysql> CREATE DATABASE gtest;
mysql> SHOW DATABASES; 
```

### IP ì ‘ì† ê°€ëŠ¥ ë²”ìœ„ ì„¤ì •

```bash
mysql> SELECT user, host FROM mysql.user;
# root ì‚¬ìš©ì ì ‘ì† ê¶Œí•œ ì‚­ì œ
mysql> DELETE FROM mysql.user WHERE User='root' AND Host='%';
mysql> FLUSH PRIVILEGES;
```

## 1.6 Redis ì„¤ì •

### Redis ì´ë¯¸ì§€ pull

```jsx
sudo docker pull redis
```

### redis container ì‹¤í–‰

```jsx
sudo docker run -p 9707:6379 --name redis-container -d redis:latest --requirepass "tou"
```

- **`-name redis-container`** : ì»¨í…Œì´ë„ˆì— **`redis-container`**ë¼ëŠ” ì´ë¦„ì„ ë¶€ì—¬
- **`p 9707:6379`** : í˜¸ìŠ¤íŠ¸ì˜ 9707 í¬íŠ¸ì™€ ì»¨í…Œì´ë„ˆì˜ 6379 í¬íŠ¸ë¥¼ ë§¤í•‘
- **`d`** : ì»¨í…Œì´ë„ˆë¥¼ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
- **`redis`** : ì‚¬ìš©í•  Docker ì´ë¯¸ì§€ì˜ ì´ë¦„
- `**requirepass`**  : ë¹„ë°€ë²ˆí˜¸

### redisê°€ ì„¤ì¹˜ëœ docker ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ì ‘ì†

```jsx
sudo docker exec -it redis-container /bin/bash
```

### redis ì ‘ì†

ubuntu

```jsx
redis-cli -p {port} -a {password}
```

cmd(ì™¸ë¶€)

```jsx
redis-cli -h {hostname} -p {port} -a {password}
```

## 1.7 Jenkins ì„¤ì¹˜

### docker-composeë¥¼ ì‚¬ìš©í•˜ì—¬ jenkins containerë¥¼ ì‹¤í–‰í•˜ê¸°

```bash
sudo vim docker-compose.yml
```

1. **jenkins containerë¥¼ ì‹¤í–‰ì‹œí‚¬ docker-compose íŒŒì¼ì„ ë§Œë“¬**


```bash
version: '3'
services:
		jenkins:
				image: jenkins/jenkins:lts
				container_name: jenkins
				volumes:
						- /var/run/docker.sock:/var/run/docker.sock
						- /jenkins:/var/jenkins_home
				ports:
						- "9090:8080"
				user: root
```

- jenkins ê¸°ë³¸ í¬íŠ¸ëŠ” 8080ì¸ë° 9090í¬íŠ¸ ì‚¬ìš©í•˜ë„ë¡ ì§€ì •í•´ì¤Œ

1. **docker-composeë¡œ jenkins containerë¥¼ ì‹¤í–‰í•˜ê¸°**
    
    `sudo docker-compose up -d`
    
2. **ì •ìƒì ìœ¼ë¡œ containerê°€ ì‹¤í–‰ë˜ê³  ìˆëŠ”ì§€ í™•ì¸**
    
    `sudo docker ps -a`

    
3. J**enkins containerì— ì ‘ì†í•˜ì—¬ Dockerë¥¼ ì„¤ì¹˜**
    1. jenkins ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì— ì ‘ì†
        
        `sudo docker exec -it jenkins /bin/bash`

        
    2. docker ì„¤ì¹˜
        
        ```bash
        ##docker ì„¤ì¹˜
        apt-get update
        apt-get install ca-certificates curl gnupg lsb-release
        mkdir -p /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
          $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
        apt-get update
        apt-get install docker-ce docker-ce-cli [containerd.io](http://containerd.io/) docker-compose-plugin docker-compose
        ```
        
4. **Jenkins ì ‘ì† (ë„ë©”ì¸ì£¼ì†Œ:9090)**

[](http://k9b310.p.ssafy.io:9090/)

# 2. Jenkins ì„¤ì •

## 2.1 ì´ˆê¸° ê³„ì • ì„¤ì •

1. ì´ˆê¸° ì ‘ì†í™”ë©´ Unlock Jenkins
    - `cat /var/jenkins_home/secrets/initialAdminPassword`
    - ì—¬ê¸°ì„œ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ê³  ì…ë ¥
2. install suggested plusins ì„ íƒ
3. Create First Admin User
    1. ê³„ì •ëª… : tou_admin
    2. ì•”í˜¸ : ###
    3. ì´ë¦„ : admin
    4. ì´ë©”ì¼ ì£¼ì†Œ : ì‹¤ì œ ì‚¬ìš©í•˜ëŠ” ê°œì¸ ì´ë©”ì¼
4. Jenkins Url 
    1. defaultì‚¬ìš©í•´ë„ ë¨,
    

## 2.2 Plugin ì„¤ì¹˜

Jenkins ê´€ë¦¬ â†’ Plugin in

### ì¶”ê°€ë¡œ ì„¤ì¹˜ í•´ì•¼ í•  plugin ëª©ë¡

- GitLab
- Generic Webhook Trigger
- GitLab API
- GitLab Authenication
- NodeJs (ìë™ ë°°í¬ë¡œ í”„ë¡ íŠ¸ì—”íŠ¸ ë¹Œë“œ ì‹œ í•„ìš”)

## 2.3 Credential ì„¤ì •

Jenkins ê´€ë¦¬ â†’ Security â†’ Credentials â†’S****tores scoped to Jenkins â†’ (global)****

â†’ + Add Credential ì„ íƒ


Username : ê¹ƒë© ì“°ëŠ” ê³„ì •

Password : ê¹ƒë© íŒ¨ìŠ¤ì›Œë“œ or ê¹ƒë© ì‹œí¬ë¦¿í† í° ì…ë ¥

ID : jenkins_token

- gitlabì—ì„œ ë¨¼ì € access Tokenì„ ë°œê¸‰ ë°›ê³  í† í°ì„ ë„£ì–´ì¤€ë‹¤.

- í† í° ë°œê¸‰ ë°›ê¸°
    
    gitlab ë¡œê·¸ì¸ â†’ ì‚¬ëŒ ëˆ„ë¦„ â†’ Edit profile â†’ access token â†’ add new token
    
    ì´ë¦„, ë§Œë£Œë‚ ì§œ, ê¶Œí•œ ë²”ìœ„ ë“±ì„ ì„¤ì •
    

Token name : new_token

## 2.4 jenkins GitLab Connection ë“±ë¡

Jenkinsê´€ë¦¬ â†’ System â†’ GitLab ì´ë™

- ì›í•˜ëŠ” connection ì´ë¦„ ì„¤ì •
    
    deploy-tou
    
- Gitlab ì£¼ì†Œ ì…ë ¥
    
    https://lab.ssafy.com/
    
- ì•ì„œ ë§Œë“  Credential ì—°ê²°

## 2.5 Jenkins pipeline ìƒì„±

- + ìƒˆë¡œìš´ Item  â†’ ì´ë¦„ ì…ë ¥, Pipeline ì„ íƒ â†’ ok
- í”„ë¡ íŠ¸ì™€ ë°±ì—”ë“œ 2ê°œë¥¼ ë§Œë“¤ì–´ì•¼ í•¨
    
    tou-back
    
    tou-front


- êµ¬ì„± â†’ build Trigger ì´ë™

- buildë¥¼ ìœ ë°œí•  Tirgger ì˜µì…˜ì„ ì„ íƒí•˜ì—¬ ì ìš©
- ê³ ê¸‰ì„ ëˆŒëŸ¬ webhook ì„¤ì •ì„ ìœ„í•œ Secret Tokenì„ ë°œê¸‰


â†’ generateë¥¼ ëˆŒëŸ¬ Secret tokenìƒì„±

## 2.6 Gitlab webhook ì„¤ì •

- jenkins ì‘ì ‘ë¬¼ì˜ ë³€í™”ë¥¼ ê°ì§€í•˜ì—¬ build, run í•˜ê¸° ìœ„í•´ì„œëŠ” webHook í•„ìˆ˜!
- gitlab project â†’ settings â†’ webhooks
    
    
- url : [http://k9b310.p.ssafy.io:9090/job/tou-front/](http://k9b310.p.ssafy.io:9090/job/tou-front/)
- secret token: jenkins Systemì—ì„œ ë°›ì•„ì˜¨ token ì…ë ¥
- mergeë¥¼ í• ë•Œë§ˆë‹¤ ìš”ì²­
    
- ssl verification

- Test : 200ì´ì—¬ì•¼ í•¨!

# 3. Back-End ë¹Œë“œ ë° ë°°í¬

## 3-1 Back-end í™˜ê²½ë³€ìˆ˜

```jsx
spring:
  # ë¡œê·¸íŒŒì¼ ì„¤ì •
  application:
    name: svc1-accounts
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url:
    username: tou
    password: 
  redis:
    host:
    port: 9707
    password: 

  batch:
    jdbc:
      initialize-schema: never
    job:
      enabled: false

  jpa:
    database: mysql
    database-platform: org.hibernate.dialect.MySQL8Dialect
    show-sql: true
    hibernate:
      ddl-auto: validate
      use-new-id-generator-mappings: false
    properties:
      hibernate:
        format_sql: true
        default_batch_fetch_size: 1000


# jwt
jwt:
  secret:
    key: 


```

<aside>
ğŸ’¡ í™˜ê²½ë³€ìˆ˜ ê´€ë ¨ ë‚´ìš© ì •ë¦¬

**ê¸°ì¡´ ë°©ì‹**

ë°±ì—”ë“œì˜ application.yml íŒŒì¼ì—ì„œ í™˜ê²½ë³€ìˆ˜ë“¤ì„ ì „ë¶€ ì‘ì„±í•˜ì—¬ ê´€ë¦¬
ë¬¸ì œì  : gitì— ì˜¬ë¼ê°€ëŠ” íŒŒì¼ì´ê¸° ë•Œë¬¸ì— ì¤‘ìš”í•œ ì •ë³´ë“¤ì˜ ê´€ë¦¬ê°€ ì–´ë ¤ì› ìŒ(DB id,pwë‚˜ token ê°’ë“¤ì´ ì „ë¶€ ë…¸ì¶œë¨)


**í˜„ì¬ë°©ì‹**

application.yml ë‘ application-secret.ymlë¡œ ê´€ë¦¬

**ì¶”í›„ë°©ì‹**

application.yml íŒŒì¼ì— í™˜ê²½ë³€ìˆ˜ë¥¼ ì§ì ‘ ì‘ì„±í•˜ì§€ ì•Šê³ 
ê°™ì€ ê²½ë¡œì— .env íŒŒì¼ì— ì‘ì„±í•¨
ìš”ì•½ : git ì—ëŠ” application.ymlíŒŒì¼ ìˆìŒ. jenkinsì—ëŠ” application.ymlíŒŒì¼ê³¼ .env íŒŒì¼ì´ ìˆìŒ.

</aside>

## 3-2 ìë°” ë° gradle ì„¤ì¹˜

```bash
# ìë°” ì„¤ì¹˜
sudo apt update
sudo apt install openjdk-17-jdk
java -version

# gradle ì„¤ì¹˜

cd /S0931B310/~~
# projeck ê²½ë¡œê¹Œì§€ ì•Œì•„ì„œ ì˜ ë“¤ì–´ê°€ë©´ëœë‹¤
sh gradlew

# gradle ì‹¤í–‰
sh gradlew build
```

## 3-3 Dockerfile ì‘ì„±

```bash
FROM openjdk:17-jdk-slim
COPY /build/libs/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "/app.jar"]

# ì•ˆë˜ì„œ ë°‘ì—ê»„ë¡œ ìˆ˜ì •í•œë²ˆ í•´ë´„

FROM openjdk:17
WORKDIR /app
COPY /build/libs/*.jar app.jar
ENTRYPOINT ["java", "-jar", "/app.jar"]
```

## 3-4 Jenkinsfile ì‘ì„±

```groovy
pipeline {
    agent any

    environment {
        CONTAINER_NAME = "tou-back"
        IMAGE_NAME = "tou"
    }
    stages {
        stage('Build') {
            steps {
                dir('back/tou') {
                    sh 'chmod +x gradlew'
                    sh './gradlew clean build'
                }
            }
            post {
                success {
                    echo 'gradle build success'
                }
                failure {
                    echo 'gradle build failed'
                }
            }
        }

        stage('Docker Delete') {
            steps {
                script {
                    try{
                        sh 'echo "Docker Delete Start"'
                        // ì»¨í…Œì´ë„ˆ ì¡´ì¬ ì‹œ ì‚­ì œ
                        sh "docker stop ${CONTAINER_NAME}"
                        sh "docker rm -f ${CONTAINER_NAME}"
                    }catch (Exception e){
                        echo "Docker container ${CONTAINER_NAME} does not exist. skip"
                    }
                    try{
                        // ì´ë¯¸ì§€ ì¡´ì¬ ì‹œ ì‚­ì œ
                        sh "docker image rm ${IMAGE_NAME}"
                    }catch (Exception e){
                        echo "Docker image ${IMAGE_NAME} does not exist. skip"
                    }
                }
            }
            post {
                success {
                    sh 'echo "Docker delete Success"'
                }
                failure {
                    sh 'echo "Docker delete Fail"'
                }
            }
        }

        stage('Dockerizing'){
            steps{
                sh 'echo " Image Bulid Start"'
                // ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì»¨í…Œì´ë„ˆ ë¹Œë“œ
                dir('back/tou') {
                    sh 'docker build -t ${IMAGE_NAME} .'
                }
            }
            post {
                success {
                    sh 'echo "Bulid Docker Image Success"'
                }
                failure {
                    sh 'echo "Bulid Docker Image Fail"'
                }
            }
        }
        stage('Deploy') {
            steps {
                script{
                    sh 'docker run --name ${CONTAINER_NAME} -d -p 8080:8080 ${IMAGE_NAME}'
                }
            }
            post {
                success {
                    echo 'Deploy success'
                }
                failure {
                    echo 'Deploy failed'
                }
            }
        }
    }
}
```

## 3-5 Jenkins ì„¤ì •

- ë¹Œë“œ ì‹¤í–‰í•´ í™•ì¸


# 4. Front-End ë¹Œë“œ ë° ë°°í¬

## 4-0 Node ì„¤ì¹˜

```bash
// 18.x ë²„ì „ ì„¤ì¹˜
curl -sL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

// ì„¤ì¹˜ í›„ ë²„ì „ í™•ì¸
node -v
npm -v
```

## 4-1 Dockerfile ì‘ì„±

(gitlab : develop-fe(branch) /í”„ì ì´ë¦„/front/Dockerfile ìƒˆë¡œ ì‘ì„±)

```bash
FROM node:18
WORKDIR /app
COPY package*.json ./
RUN npm install
RUN npm install -g serve
COPY . .
RUN npm run build
ENTRYPOINT ["serve", "-s", "build"]
```

## 4-2 Jenkinsfile ì‘ì„±

(gitlab : develop-fe(branch) /í”„ì ì´ë¦„/front/Jenkinsfile ìƒˆë¡œ ì‘ì„±)

```bash
pipeline {
    agent any

     tools {nodejs "node"}

     environment {
        DOCKER = 'sudo docker'
        TIME_ZONE = 'Asia/Seoul'
        TAG = "docker-react:${env.BUILD_ID}"
    }

stages {
    stage('prepare') {
        steps {
            dir('FrontEnd'){
                sh 'npm install'
            }
        }
    }
    stage('build') {
        steps {
            dir('FrontEnd'){
                sh 'CI=false npm run build'
                sh '''
                echo 'Docker image build'
                docker build --no-cache -t $TAG .
                '''
            }
        }
    }
    stage('Deploy') {
            steps {
                dir('FrontEnd'){
                    script {
                        try {
                            sh 'docker stop TouFront'
                            sh 'docker rm TouFront'
                        } catch (Exception e) {
                            echo "Failed to stop or remove Docker container, proceeding anyway"
                        }
                    }
                    sh '''
                    echo 'Deploy'
                    docker run -d -p 3000:3000 -v /etc/localtime:/etc/localtime:ro -e TZ=Asia/Seoul --name TouFront $TAG
                    '''
                }
            }
        }
}
}
```

ì°¸ê³ ìë£Œ

[[Jenkins] ë¦¬ì•¡íŠ¸ ê²½ê³ ë¥¼ ë¹Œë“œ ì˜¤ë¥˜ë¡œ ì¸ì‹í•˜ëŠ” ì„¤ì •](https://velog.io/@mungmnb777/ì  í‚¨ìŠ¤-ë¦¬ì•¡íŠ¸-ê²½ê³ ë¥¼-ë¹Œë“œ-ì˜¤ë¥˜ë¡œ-ì¸ì‹í•˜ëŠ”-ì„¤ì •)

## 4-3 Jenkins ì„¤ì •

Script Path : front/jenkinsfile

- jenkins ê´€ë¦¬ â†’ Tools â†’ NodeJs ì„¤ì •
- node ë²„ì „ê³¼ ì´ë¦„ì„ ì…ë ¥
- ì§€ê¸ˆ ë¹Œë“œ ì‹¤í–‰í•˜ì—¬ í™•ì¸
    

# 5. ê°€ë¹„ì•„ ë„ë©”ì¸ ì—°ê²°

## 5-1. ê°€ë¹„ì•„ ì ‘ì†

<aside>
ğŸ’¡ ê°€ë¹„ì•„ ë¡œê·¸ì¸ â†’ Myê°€ë¹„ì•„ â†’ ì„œë¹„ìŠ¤ ê´€ë¦¬ â†’ í•´ë‹¹ ë„ë©”ì¸(tou.kr) ì„ íƒ í›„ ê´€ë¦¬ í´ë¦­â†’ DNS ì •ë³´ â†’ DNS ê´€ë¦¬

</aside>

## 5-2. DNS ì„¤ì •

<aside>
ğŸ’¡ **DNS ì„¤ì •ì— ë ˆì½”ë“œ ì¶”ê°€

1.íƒ€ì…: A
1. í˜¸ìŠ¤íŠ¸: @  / www
2. ê°’ ìœ„ì¹˜ : ë°°í¬ëœ ì„œë²„ì˜ ipv4 ì£¼ì†Œ 
 ( ë°°í¬ ì„œë²„ì— ubuntuë¡œ ì ‘ì† í›„
 `curl [http://169.254.169.254/latest/meta-data/public-ipv4](http://169.254.169.254/latest/meta-data/public-ipv4)` ëª…ë ¹ì–´ ì…ë ¥**


**ubuntu@ ì•ë¶€ë¶„ì´ ipv4 ì£¼ì†Œì„

1. ë“±ë¡ í›„ ì €ì¥**

</aside>

## 5-3. NGINX ì„¤ì •

```bash
server {
    #  80ë²ˆ í¬íŠ¸ì—ì„œ ì—°ê²° ìˆ˜ì‹ 
    listen 80;
    server_name k9b310.p.ssafy.io **www.tou.kr tou.kr; // ì¶”ê°€**
    return 301 https://$host$request_uri;
}

# HTTPS ë¡œ ì—°ê²° ìˆ˜ì‹ 
server {
    listen 443 ssl;
    server_name k9b310.p.ssafy.io;

    ssl_certificate /etc/letsencrypt/live/k9b310.p.ssafy.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/k9b310.p.ssafy.io/privkey.pem;

    # springbootì— ëŒ€í•œ í”„ë¡ì‹œ ì„¤ì •
    location /api {
        # rewrite ^/api(/.*)$ $1 break;
        proxy_pass http://k9b310.p.ssafy.io:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # í”„ë¡ íŠ¸ì— ëŒ€í•œ í”„ë¡ì‹œ ì„¤ì •
    location / {
        proxy_pass http://k9b310.p.ssafy.io:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
```

ì´ëŸ¬ë©´ https ì—°ê²°ì€ ë˜ëŠ”ë° ì¸ì¦ì„œê°€ ì—†ì–´ì„œ ë³´ì•ˆ ìœ„í—˜ ì•Œë¦¼ì´ ëœ¸

## 5-4. CERTBOTì„ í†µí•œ https ì¸ì¦ì„œ ë°œê¸‰

ì•„ë˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ Certbotì€ Nginx ì„¤ì •ì„ ê²€ì‚¬í•˜ì—¬ ë³´ì•ˆ ì¸ì¦ì„œê°€ í•„ìš”í•œ ëª¨ë“  ì„œë²„ ë¸”ë¡ì„ ì°¾ìŒ

```bash
sudo certbot --nginx
```

ì—¬ê¸°ì„œ ì „ë¶€ë¥¼ íƒí•´ì„œ ì¸ì¦ì„œë¥¼ ë°œê¸‰ë°›ê±°ë‚˜

```bash
sudo certbot --nginx -d k9b310.p.ssafy.io -d tou.kr -d www.tou.kr
```

ëª…ë ¹ì–´ë¥¼ í†µí•´ í•˜ë‚˜ì˜ ì¸ì¦ì„œì— ì—¬ëŸ¬ ë„ë©”ì¸ì„ í¬í•¨ì‹œí‚¬ ìˆ˜ ìˆìŒ

í˜¹ì€ ì´ë¯¸ ë°œê¸‰ë°›ì€ ì¸ì¦ì„œì— Certbotì„ ì‚¬ìš©í•´ ì¸ì¦ì„œ í™•ì¥í•  ìˆ˜ ìˆìŒ

```bash
sudo certbot --expand -d k9b310.p.ssafy.io -d tou.kr -d www.tou.kr
```

## 5-5. NGINX ì¬ì„¤ì •

```bash
server {
    listen 80;
    server_name k9b310.p.ssafy.io www.tou.kr tou.kr;

    if ($host = www.tou.kr) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    if ($host = tou.kr) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    if ($host = k9b310.p.ssafy.io) {
        return 301 https://tou.kr$request_uri;
    }
}

# HTTPS ë¡œ ì—°ê²° ìˆ˜ì‹ 
server {
    listen 443 ssl;
    server_name k9b310.p.ssafy.io k9b310.p.ssafy.io www.tou.kr tou.kr;

    **//ì¸ì¦ì„œ í‚¤ë¥¼ ì¬ ì§€ì •**
    # k9b310.p.ssafy.io, tou.kr ë° www.tou.krì— ëŒ€í•œ ì¸ì¦ì„œ ì„¤ì •
    **ssl_certificate /etc/letsencrypt/live/tou.kr/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/tou.kr/privkey.pem; # managed by Certbot**

    **//ë„ë©”ì¸ ì£¼ì†Œë¡œ ë¦¬ë””ë ‰ì…˜**
		if ($host = k9b310.p.ssafy.io) {
        return 301 https://tou.kr$request_uri;
    }

    # springbootì— ëŒ€í•œ í”„ë¡ì‹œ ì„¤ì •
    location /api {
        # rewrite ^/api(/.*)$ $1 break;
        proxy_pass http://k9b310.p.ssafy.io:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # í”„ë¡ íŠ¸ì— ëŒ€í•œ í”„ë¡ì‹œ ì„¤ì •
    location / {
        proxy_pass http://k9b310.p.ssafy.io:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		    proxy_set_header X-Forwarded-Proto $scheme;
		}
}
```

### 5-6. ì¬ ì§€ì •í•  ì¸ì¦ì„œë¥¼ íƒí•  ë•Œ ì°¸ê³ ì‚¬í•­

1.**`/etc/letsencrypt/live`** ë””ë ‰í† ë¦¬ë¥¼ í™•ì¸

```bash
sudo ls -l /etc/letsencrypt/live
```


1. ì¸ì¦ì„œ íŒŒì¼ë“¤ì´ ì–´ë–¤ ë„ë©”ì¸ë“¤ì„ ì»¤ë²„í•˜ëŠ”ì§€ ì„¸ë¶€ ì •ë³´ í™•ì¸

```bash
sudo openssl x509 -in /etc/letsencrypt/live/tou.kr/cert.pem -text -noout
```

3.'Subject Alternative Name' í•„ë“œë¥¼ í†µí•´ ì¶”ê°€ëœ ë„ë©”ì¸ í™•ì¸í•˜ê³  ëª¨ë‘ë¥¼ í¬í•¨í•˜ëŠ” ì¸ì¦ì„œë¥¼ nginxì— ì¶”ê°€í•˜ë©´ ë¨.

-  ì°¸ê³  ë¸”ë¡œê·¸

[AWS EC2 ubuntu ê°€ë¹„ì•„ ë„ë©”ì¸ ì ìš©](https://king-ja.tistory.com/102)

[[ec2 2íƒ„] ê°€ë¹„ì•„ì—ì„œ ë„ë©”ì¸ êµ¬ë§¤ í›„ ì—°ê²°í•˜ê¸° & HTTPS ì ìš©í•˜ê¸°](https://ye5ni.tistory.com/132)

# 6. ì„œë²„ ë°°í¬ ì‹œ ë¬¸ì œì˜€ë˜ ìƒí™©ë“¤

## 6-1 nginx upstream ì˜¤ë¥˜

Jenkins CI/CDê°€ ì™„ë£Œ ë˜ì—ˆê³ , ë¹Œë“œ í…ŒìŠ¤íŠ¸ ë˜í•œ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆì§€ë§Œ ì„œë²„ì— API ìš”ì²­ì„ ë³´ë‚´ë©´ 504 gateway ì—ëŸ¬ê°€ ë°œìƒí–ˆë‹¤

ì˜¤ë¥˜ë¡œê·¸ë¥¼ í™•ì¸í•´ë³¸ ê²°ê³¼ ( ì˜¤ë¥˜ ë¡œê·¸ í™•ì¸ )
`sudo tail -f /var/log/nginx/error.log`

```bash
2023/11/02 00:22:57 [error] 89194#89194: *2 upstream timed out 
(110: Connection timed out) while connecting to upstream, 
client: 14.50.47.171, server: k9b310.p.ssafy.io, 
request: "GET /api/client/login HTTP/1.1", 
upstream: "http://3.35.139.182:8080/api/client/login", 
host: "k9b310.p.ssafy.io", 
referrer: "http://k9b310.p.ssafy.io/api/client/login"
```

ì´ëŸ° ì—ëŸ¬ ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.

êµ¬ê¸€ë§ ê²°ê³¼ API ìš”ì²­ì˜ ì‹œê°„ ê°’ì„ ëŠ˜ë ¤ì¤˜ì•¼í•œë‹¤ëŠ” ê²°ë¡ ì´ ë‚˜ì™”ê³ , ëŠ˜ë ¤ì£¼ì—ˆìœ¼ë‚˜ ì—¬ì „íˆ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí•˜ê³  ìˆë‹¤

## 6-2 nginx upstream ì˜¤ë¥˜ í•´ê²°

application.yml íŒŒì¼ê³¼ .env íŒŒì¼ì˜ ë§¤í•‘ì´ ì •í™•í•˜ê²Œ ì´ë£¨ì–´ì§€ì§€ì•Šì•„ ë°œìƒí•¨

í•´ê²°ë°©ë²•ì€ 4-1 í•˜ë‹¨ì— ê¸°ì¬í•¨


</div>
</details>

<details>
<summary>ì™¸ë¶€ API</summary>
<div markdown="1">   

#### êµ¬ê¸€ì„ ì´ìš©í•œ ì§€ë„ Api ì‚¬ìš©
- ì‚¬ìš©ìì˜ ìœ„ì¹˜ì™€ íŒë§¤ì ì˜ ìœ„ì¹˜ë¥¼ ë¹„êµí•˜ì—¬ ì œí’ˆì˜ ìœ í†µ ê³¼ì • ìœ„ë³€ì¡° íŒë³„

</div>
</details>